name: Auto Package and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          mkdir -p releases temp
          echo "RELEASE_TAG=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV
      
      - name: Process plugins
        id: process
        run: |
          FOLDERS=("custom-code-manager" "smart-sitemap" "teo-cache-purge")
          RELEASE_FILES=""
          RELEASE_NOTES="## 插件版本\n\n"
          
          for folder in "${FOLDERS[@]}"; do
            if [ -d "$folder" ]; then
              echo "Processing $folder..."
              
              # 查找 PHP 文件并提取版本号
              php_file="${folder}/${folder}.php"
              
              if [ -f "$php_file" ]; then
                # 提取 Version 字段
                version=$(grep -i "^ \* Version:" "$php_file" | head -1 | sed 's/.*Version: *\([0-9.]*\).*/\1/')
                
                if [ -n "$version" ]; then
                  echo "Found version: $version for $folder"
                  
                  # 创建临时目录结构
                  temp_dir="temp/${folder}"
                  mkdir -p "$temp_dir"
                  
                  # 复制所有文件到临时目录（保持插件目录结构）
                  cp -r "$folder"/* "$temp_dir/"
                  
                  # 创建 zip 文件（包含插件目录）
                  zip_name="${folder}-${version}.zip"
                  cd "temp"
                  zip -r "../releases/${zip_name}" "$folder" -x "*.git*" "*.DS_Store"
                  cd ..
                  
                  # 清理临时文件
                  rm -rf "temp/${folder}"
                  
                  RELEASE_FILES="${RELEASE_FILES}releases/${zip_name},"
                  RELEASE_NOTES="${RELEASE_NOTES}- **${folder}**: v${version}\n"
                else
                  echo "Warning: Version not found in $php_file"
                fi
              else
                echo "Warning: $php_file not found"
              fi
            else
              echo "Warning: Directory $folder not found"
            fi
          done
          
          # 移除最后的逗号
          RELEASE_FILES=${RELEASE_FILES%,}
          
          echo "release_files=$RELEASE_FILES" >> $GITHUB_OUTPUT
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          body: ${{ steps.process.outputs.release_notes }}
          files: ${{ steps.process.outputs.release_files }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cleanup
        run: |
          rm -rf releases temp
      
      - name: Summary
        run: |
          echo "## Release Created Successfully! 🎉" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: release-${{ env.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.process.outputs.release_notes }}" >> $GITHUB_STEP_SUMMARY
