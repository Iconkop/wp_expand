name: Auto Package and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          mkdir -p releases temp
          echo "RELEASE_TAG=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV
      
      - name: Process plugins
        id: process
        run: |
          FOLDERS=("custom-code-manager" "smart-sitemap" "teo-cache-purge")
          RELEASE_FILES=""
          RELEASE_NOTES="## æ’ä»¶ç‰ˆæœ¬\n\n"
          
          for folder in "${FOLDERS[@]}"; do
            if [ -d "$folder" ]; then
              echo "Processing $folder..."
              
              # æŸ¥æ‰¾ PHP æ–‡ä»¶å¹¶æå–ç‰ˆæœ¬å·
              php_file="${folder}/${folder}.php"
              
              if [ -f "$php_file" ]; then
                # æå– Version å­—æ®µ
                version=$(grep -i "^ \* Version:" "$php_file" | head -1 | sed 's/.*Version: *\([0-9.]*\).*/\1/')
                
                if [ -n "$version" ]; then
                  echo "Found version: $version for $folder"
                  
                  # åˆ›å»ºä¸´æ—¶ç›®å½•ç»“æž„
                  temp_dir="temp/${folder}"
                  mkdir -p "$temp_dir"
                  
                  # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•ï¼ˆä¿æŒæ’ä»¶ç›®å½•ç»“æž„ï¼‰
                  cp -r "$folder"/* "$temp_dir/"
                  
                  # åˆ›å»º zip æ–‡ä»¶ï¼ˆåŒ…å«æ’ä»¶ç›®å½•ï¼‰
                  zip_name="${folder}-${version}.zip"
                  cd "temp"
                  zip -r "../releases/${zip_name}" "$folder" -x "*.git*" "*.DS_Store"
                  cd ..
                  
                  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                  rm -rf "temp/${folder}"
                  
                  RELEASE_FILES="${RELEASE_FILES}releases/${zip_name},"
                  RELEASE_NOTES="${RELEASE_NOTES}- **${folder}**: v${version}\n"
                else
                  echo "Warning: Version not found in $php_file"
                fi
              else
                echo "Warning: $php_file not found"
              fi
            else
              echo "Warning: Directory $folder not found"
            fi
          done
          
          # ç§»é™¤æœ€åŽçš„é€—å·
          RELEASE_FILES=${RELEASE_FILES%,}
          
          echo "release_files=$RELEASE_FILES" >> $GITHUB_OUTPUT
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          body: ${{ steps.process.outputs.release_notes }}
          files: ${{ steps.process.outputs.release_files }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cleanup
        run: |
          rm -rf releases temp
      
      - name: Summary
        run: |
          echo "## Release Created Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: release-${{ env.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.process.outputs.release_notes }}" >> $GITHUB_STEP_SUMMARY
